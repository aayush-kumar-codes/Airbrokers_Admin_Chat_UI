{% extends 'partials/base.html' %}
{% load static %}
{% load custom_tags %}
{% block head_title%}
        <title>FL_Forms_File</title>
{% endblock %}
{% block extra_css %}
        <!-- DataTables -->
        <link href="{% static 'libs/datatables.net-bs4/css/dataTables.bootstrap4.min.css' %}" rel="stylesheet" type="text/css" />

        <!-- Responsive datatable examples -->
        <link href="{% static 'libs/datatables.net-responsive-bs4/css/responsive.bootstrap4.min.css' %}" rel="stylesheet" type="text/css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf_viewer.min.css">
{% endblock %}
{% block content %}
            <div class="main-content">  
                <div class="page-content">
                    <div class="container-fluid">

                        <!-- start page title -->
                        <div class="row">
                            <div class="col-12">
                                <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                                </div>
                            </div>
                        </div>
                        <!-- end page title -->

                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <h5 class="card-title" id="file-name">{{ file.name }}</span></h5>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex flex-wrap align-items-center justify-content-end gap-2 mb-3">
                                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#QuestionModal">
                                         <span data-feather="file-plus"></span> Add Questions
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- end row -->

                        <!-- Add Question Modal -->
                        <div class="modal fade" id="QuestionModal" tabindex="-1" aria-labelledby="QuestionModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-scrollable modal-xl">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="QuestionModalLabel">Add Questions&nbsp;</h5>
                                        <button class="btn btn-success btn-sm" type="button" onclick="addInputField()"><i class="fa-solid fa-plus"></i></button>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="hideError()" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <!-- Form for adding Question -->
                                        <form id="addQuestionForm">
                                            {% csrf_token %}
                                            <div class="mb-3">
                                                <input type="text" class="form-control" name="question" placeholder="Enter your question here..">
                                            </div>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <div id="errorContainer" style="color: red;"></div>
                                        <button type="button" class="btn btn-light" onclick="hideError()" data-bs-dismiss="modal">Close</button>
                                        <button type="submit" onclick="submitQuestionAddForm()" class="btn btn-primary">Save</button>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <div class="table-responsive mb-4">
                            <table class="table align-middle datatable dt-responsive table-check nowrap" style="border-collapse: collapse; border-spacing: 0 8px; width: 100%;">
                                <thead>
                                  <tr>
                                    <th scope="col">Description</th>
                                    <th scope="col">Url</th>
                                    <th scope="col">Preview_image</th>
                                    <th scope="col">Added_at</th>
                                    <th scope="col">Updated_at</th>
                                  </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>{{ file.description }}</td>
                                        <td><a href='{{ BASE_URL }}{{ file.url }}' target="_blank">view</a></td>
                                        <td><a href='{{ BASE_URL }}{{ file.preview_image }}' target="_blank">preview</a></td>
                                        <td>{{ file.added_at }}</td>  
                                        <td>{{ file.updated_at }}</td>
                                    </tr>
                                </tbody>
                            </table>
                            <!-- end table -->
                        </div>
                        <!-- end table responsive -->

                        <!--Questions-->
                        <div class="row align-items-center mb-3">
                            <h5 class="card-title"><span>Questions</span></h5>
                       </div>

                        <div class="table-responsive mb-4">
                            <!-- Selecting a Question -->
                            <table class="table align-middle datatable dt-responsive table-check nowrap" style="border-collapse: collapse; border-spacing: 0 8px; width: 100%;">
                                <thead>
                                    <tr>
                                        <th scope="col">Select</th>
                                        <th scope="col">Question</th>
                                        <th scope="col">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for question in file.questions %}
                                    <tr class="question-item" data-question-id="{{ question.question_id }}" data-answer-locs="{{ question.answer_locations|to_json }}">
                                        <td>
                                            <input type="checkbox" class="form-check-input border border-secondary question-checkbox fs-5">
                                        </td>
                                        <td>
                                            <p>{{ question.text }}</p>
                                        </td>
                                        <td>
                                            <div class="d-flex gap-2">
                                                <button id="mark-answer-button" class="btn btn-success mark-answer-btn d-none">Mark Answer</button>
                                                <button type="button" class="btn btn-info edit-question" data-bs-toggle="modal" data-bs-target="#editQuestionModal" data-question="{{ question.question_id }},{{ question.text }}">Edit</button>
                                                <button class="btn btn-danger delete-question" data-bs-toggle="modal" data-bs-target="#deleteQuestionModal" data-question="{{ question.question_id }}">Delete</button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>    
                       <!-- end Questions -->

                       <!-- Pdf File -->
                        <div class="position-absolute h-100 start-50 top-50 z-3"> 
                            <div id="loader" class="spinner-border text-warning " style="border-width: 0.4em;" role="status"></div>
                        </div>
                       <div class="row mt-5 mb-2">
                            <div class="col-md-4 mb-5 card" style="height:260px;">
                                <div id="input-type-dropdown" class="mt-3 d-none">
                                    <label for="answer-input-type" class="form-label">Answer Input Type:<span style="color: red;">*</span></label>
                                    <select id="answer-input-type" class="form-select">
                                        <option value="">Select</option>
                                        <option value="single-line">Single Line</option>
                                        <option value="multiline">Multiline</option>
                                        <option value="single-checkbox">Checkbox (Single)</option>
                                        <option value="multiple-checkbox">Checkbox (Multiple)</option>
                                    </select>
                                </div>
                                <div id="checkbox-text" class="d-flex flex-column justify-content-center mt-3 d-none">
                                    <div class="mb-2">
                                        <label for="checkbox-value" class="form-label">Enter the value for marked checkbox:<span style="color: red;">*</span></label>
                                    </div>
                                    <div class="mb-2 d-flex gap-2">
                                        <input type="text" id="checkbox-value" name="checkbox_value" class="form-control" placeholder="Enter the value here..">
                                        <div>
                                            <button id="checkbox-value-button" type="button" class="btn btn-primary">Save</button>
                                        </div>
                                    </div>
                                    <div id="CheckboxErrorContainer" style="color: red;"></div> 
                                </div>   
                                                            
                            </div>
                            <div class="col-md-8"  style="overflow:auto;">
                                <canvas id="pdf-canvas" class="border border-secondary d-none"></canvas>
                                <div id="pageNumber" class="d-flex justify-content-center mt-2 gap-3 d-none">
                                    <a id="prev-page" class="btn btn-outline-primary"><i class="fa-solid fa-circle-left fa-lg"></i></a>
                                    <span>Page: <span id="page-num"></span> / <span id="page-count"></span></span>
                                    <a id="next-page" class="btn btn-outline-primary"><i class="fa-solid fa-circle-right fa-lg"></i></a>
                                </div>
                            </div>
                        </div>      
                        
                        <!-- Delete Question -->
                        <div class="modal fade" id="deleteQuestionModal" tabindex="-1" role="dialog" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-scrollable">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Delete Question</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <p><strong>Do you want to delete the Question?</strong></p>
                                    </div>
                                    <form id="deleteQuestionForm">
                                        {% csrf_token %} 
                                        <div class="mb-3">
                                            <input hidden type="text" id="delete-question-id" name="delete_question_id">
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                                            <button type="button" class="btn btn-danger" onclick="submitQuestionDeleteForm()">Yes</button>
                                        </div>
                                    </form>
                                </div><!-- /.modal-content -->
                            </div><!-- /.modal-dialog -->
                        </div><!-- /.modal -->

                        <!-- Edit Question modal -->
                        <div class="modal fade" id="editQuestionModal" tabindex="-1" role="dialog" aria-labelledby="editQuestionModal" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-scrollable modal-xl">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="editQuestionModalTitle">Edit question</h5>
                                        <button type="button" class="btn-close" onclick="hideError()" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="editQuestionForm">
                                            {% csrf_token %} 
                                            <div class="modal-body">
                                                <!-- <div class="mb-3">
                                                    <label for="edit-page-input" class="form-label">PDF Page No.</label>
                                                    <input type="text" id="edit-page-input" name="page" class="form-control" readonly>
                                                </div> -->
                                                <div class="mb-3">
                                                    <label for="oldquestion" class="form-label">Question</label>
                                                    <input hidden type="text" class="form-control" id="edit-question-id" name="edit_question_id" readonly>
                                                    <input type="text" class="form-control" id="oldquestion" name="oldquestion" readonly>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="editquestion" class="form-label">New Question<span style="color: red;">*</span></label>
                                                    <input type="text" class="form-control" id="editquestion" name="editquestion" placeholder="Enter your new Question..">
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <div id="editErrorContainer" style="color: red;"></div>
                                        <button type="button" class="btn btn-light" onclick="hideError()" data-bs-dismiss="modal">Close</button>
                                        <button type="button" onclick="submitQuestionEditForm()" class="btn btn-primary">Save</button>
                                    </div>
                                </div><!-- /.modal-content -->
                            </div><!-- /.modal-dialog -->
                        </div><!-- /.modal -->

                    </div> <!-- container-fluid -->
                </div>
                <!-- End Page-content -->
{% endblock %}


{% block extra_js %}
    <!-- Required datatable js -->
    <script src="{% static 'libs/datatables.net/js/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'libs/datatables.net-bs4/js/dataTables.bootstrap4.min.js' %}"></script>
    
    <!-- Responsive examples -->
    <script src="{% static 'libs/datatables.net-responsive/js/dataTables.responsive.min.js' %}"></script>
    <script src="{% static 'libs/datatables.net-responsive-bs4/js/responsive.bootstrap4.min.js' %}"></script>
    <!-- init js -->
    <script src="{% static 'js/pages/datatable-pages.init.js' %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const url = '{{ BASE_URL }}{{ file.url }}';
            
            let pdfDoc = null,
                pageNum = 1,
                pageIsRendering = false,
                pageNumIsPending = null,
                scale = 1.5,
                canvas = document.getElementById('pdf-canvas'),
                ctx = canvas.getContext('2d'),
                startX = 0,
                startY = 0,
                endX = 0,
                endY = 0,
                isMarking = false,
                currentRect = [],
                selectedQuestionId = null;
                selectedAnswerInputType =  null;
        
            const renderPage = num => {
                pageIsRendering = true;
        
                pdfDoc.getPage(num).then(page => {
                    const viewport = page.getViewport({ scale });
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
        
                    const renderCtx = {
                        canvasContext: ctx,
                        viewport
                    };
        
                    page.render(renderCtx).promise.then(() => {
                        pageIsRendering = false;
        
                        if (pageNumIsPending !== null) {
                            renderPage(pageNumIsPending);
                            pageNumIsPending = null;
                        }
                        canvas.classList.remove('d-none');
                        document.getElementById('pageNumber').classList.remove('d-none');
                        document.getElementById("loader").style.display = "none";

                        // Draw the current rectangle if it exists
                        if (currentRect.length != 0 && selectedQuestionId) {
                            for (let i = 0; i < currentRect.length; i++) {
                                if (currentRect[i].pageNum === pageNum){
                                    ctx.fillStyle = 'yellow';
                                    ctx.fillRect(currentRect[i].startX, currentRect[i].startY, currentRect[i].endX - currentRect[i].startX, currentRect[i].endY - currentRect[i].startY);
                                } 
                            }    
                        }
                    });
        
                    document.getElementById('page-num').textContent = num;
                });
            };
        
            const queueRenderPage = num => {
                if (pageIsRendering) {
                    pageNumIsPending = num;
                } else {
                    renderPage(num);
                }
            };
        
            const showPrevPage = () => {
                if (pageNum <= 1) {
                    return;
                }
                pageNum--;
                queueRenderPage(pageNum);
            };
            
            const showNextPage = () => {
                if (pageNum >= pdfDoc.numPages) {
                    return;
                }
                pageNum++;
                queueRenderPage(pageNum);
            };
        
            pdfjsLib.getDocument(url).promise.then(pdfDoc_ => {
                pdfDoc = pdfDoc_;
                document.getElementById('page-count').textContent = pdfDoc.numPages;
                renderPage(pageNum);
            }).catch(err => {
                console.error("Error loading PDF: ", err.message);
            });
        
            document.getElementById('prev-page').addEventListener('click', showPrevPage);
            document.getElementById('next-page').addEventListener('click', showNextPage);
        
            document.querySelectorAll('.question-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const questionItem = this.closest('.question-item');
                    const questionId = questionItem.getAttribute('data-question-id');
                    const answerLocations = JSON.parse(questionItem.getAttribute('data-answer-locs'))
                    const questionText = questionItem.querySelector('p');
                    document.querySelectorAll('.question-item').forEach(q => q.style.backgroundColor = '');
                    document.querySelectorAll('.mark-answer-btn').forEach(btn => btn.classList.add('d-none'));
                   
                    selectedQuestionId = questionId;
        
                    if (this.checked) {
                        document.querySelectorAll('.question-checkbox').forEach(cb => cb.checked = false);
                        this.checked = true;
                        currentRect = [];
                        document.getElementById('answer-input-type').disabled=true;

                        if (answerLocations.length != 0){
                            for (let i = 0; i < answerLocations.length; i++) {
                                // Retrieve answer location data
                                const startX = parseFloat(answerLocations[i].startX);
                                const endX = parseFloat(answerLocations[i].endX);
                                const startY = parseFloat(answerLocations[i].startY);
                                const endY = parseFloat(answerLocations[i].endY);
                                const page = parseFloat(answerLocations[i].pageNum);
                                // Push each answer location to the currentRect array
                                currentRect.push({ startX, startY, endX, endY, pageNum:page});
                            }
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            renderPage(pageNum);
                        }else{
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            document.getElementById('answer-input-type').disabled=false;
                            renderPage(pageNum);
                        }
                        document.getElementById('answer-input-type').addEventListener('change', function() {
                            selectedAnswerInputType = this.value;
                            startX = 0; startY = 0; endX = 0; endY = 0;
                            currentRect = [];
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            renderPage(pageNum);
                            questionItem.querySelector('.mark-answer-btn').classList.add('d-none');
                            document.getElementById('checkbox-text').classList.add('d-none');
                        });
 
                        document.getElementById('input-type-dropdown').classList.remove('d-none');
                    } else {
                        currentRect = [];
                        selectedQuestionId = null;
                        selectedAnswerInputType = null;
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        renderPage(1); // Render the first page or any default page
                        questionItem.querySelector('.mark-answer-btn').classList.add('d-none');
                        document.getElementById('answer-input-type').value='';
                        document.getElementById('input-type-dropdown').classList.add('d-none');
                        document.getElementById('checkbox-text').classList.add('d-none');
                    }
                });
            });
        
            canvas.addEventListener('mousedown', function(event) {
                if (!selectedQuestionId || (selectedAnswerInputType != 'single-line' && selectedAnswerInputType != 'multiline')) return;
                isMarking = true;
                const rect = canvas.getBoundingClientRect();
                startX = event.clientX - rect.left;
                startY = event.clientY - rect.top;
            
            });
        
            canvas.addEventListener('mouseup', function(event) {
                if (!isMarking || !selectedQuestionId || (selectedAnswerInputType != 'single-line' && selectedAnswerInputType != 'multiline')) return;
                isMarking = false;
        
                const rect = canvas.getBoundingClientRect();
                endX = event.clientX - rect.left;
                endY = event.clientY - rect.top;

                // Finalize the rectangle
                endY = startY + 22; 
                ctx.fillStyle = 'rgba(0, 255, 255, 0.5)';
                     
                ctx.fillRect(startX, startY, endX - startX, endY - startY);
                currentRect.push({
                    startX,
                    startY,
                    endX,
                    endY,
                    pageNum
                });
              
                // Show the Mark Answer button for the selected question
                document.querySelectorAll('.question-item').forEach(item => {
                    if (item.getAttribute('data-question-id') === selectedQuestionId) {
                        item.querySelector('.mark-answer-btn').classList.remove('d-none');
                    }
                });
            });
            
            canvas.addEventListener("dblclick", function(event) {
                if (!selectedQuestionId || (selectedAnswerInputType != 'single-checkbox' && selectedAnswerInputType != 'multiple-checkbox')) return;
                if (!document.getElementById('checkbox-text').classList.contains('d-none') && selectedAnswerInputType == 'multiple-checkbox') return;
            
                document.getElementById('CheckboxErrorContainer').innerText = '';
            
                const rect = canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
            
                // Draw a small filled square on the canvas
                ctx.fillStyle = 'red';
                ctx.fillRect(x, y, 15, 15);
            
                startX = x; startY = y; endX = x + 15; endY = y + 15;
            
                var newRect = { startX, startY, endX, endY, pageNum};
            
                if (selectedAnswerInputType == 'multiple-checkbox') {
                    document.getElementById('checkbox-text').classList.remove('d-none');
            
                    // Remove any previous event listener
                    const button = document.getElementById('checkbox-value-button');
                    const newButton = button.cloneNode(true);
                    button.parentNode.replaceChild(newButton, button);
            
                    newButton.addEventListener('click', function() {
                        const value = document.getElementById('checkbox-value').value;
                        if (!value) {
                            document.getElementById('CheckboxErrorContainer').innerText = "Checkbox value is required";
                            return;
                        }
            
                        newRect.value = value;
                        currentRect.push(newRect);
            
                        document.getElementById('checkbox-value').value = '';
                        document.getElementById('checkbox-text').classList.add('d-none');
                        document.getElementById('CheckboxErrorContainer').innerText = '';
                    });
                } else {
                    currentRect.push(newRect);
                }
           
                // Show the Mark Answer button for the selected question
                document.querySelectorAll('.question-item').forEach(item => {
                    if (item.getAttribute('data-question-id') === selectedQuestionId) {
                        item.querySelector('.mark-answer-btn').classList.remove('d-none');
                    }
                });
            });
            
            
            document.querySelectorAll('.mark-answer-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (!currentRect || !selectedQuestionId) return;

                    currentRect.forEach(obj => {
                        obj.answer_input_type = selectedAnswerInputType;
                    });
                    
                    const markerData = {
                        currentRect,
                        edit_question_id: selectedQuestionId,
                        document_id: '{{ file.id }}'
                    };
                    
                    var successToast = document.getElementById('borderedToast2');
        
                    fetch("{% url 'forms_save_marker' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(markerData)
                    }).then(response => {
                        if (!response.ok) {
                            var toastDiv = document.getElementById('toast-type');
                            toastDiv.classList.add('bg-danger');
                            document.querySelector('.toast-body').innerText="Something went wrong";  
                        }
                        return response.json();
                    }).then(data => {
                        if (data.success){
                            var toastDiv = document.getElementById('toast-type');
                            toastDiv.classList.add('bg-success');
                            document.querySelector('.toast-body').innerText="Answer location marked successfully!";
                        }else{
                            var toastDiv = document.getElementById('toast-type');
                            toastDiv.classList.add('bg-danger');
                            document.querySelector('.toast-body').innerText=data.error;  
                        }
                    }).catch(error => {
                        var toastDiv = document.getElementById('toast-type');
                        toastDiv.classList.add('bg-danger');
                        document.querySelector('.toast-body').innerText="Something went wrong";  
                    });
                    var toast = new bootstrap.Toast(successToast);
                    toast.show();
        
                    //Reset the state
                    btn.classList.add('d-none');
                    currentRect = [];
                    selectedQuestionId = null;
                });
            });
        });
        
        
        function refreshPage(){
            location.reload();
        }

        function hideError(){
            var addQuestionForm = document.getElementById('addQuestionForm');
            var editQuestionForm = document.getElementById('editQuestionForm');
            var errorContainer = document.getElementById('errorContainer');
            var editerrorContainer = document.getElementById('errorContainer');
            if (errorContainer){
                errorContainer.innerText = '';
            }
            if(editerrorContainer){
                editerrorContainer.innerText = '';
            }
            if(addQuestionForm){
                const formFields = addQuestionForm.elements;
                formFields[2].value = '';
            }
            if(editQuestionForm){
                editQuestionForm.reset();
            }
        }
        

        document.addEventListener('DOMContentLoaded', function() {
            const editButtons = document.querySelectorAll('.edit-question');
            editButtons.forEach(function(button) {
                button.addEventListener('click', function(event) {
                    var questionData = event.currentTarget.dataset.question;
                    var questionParts = questionData.split(',');
                    document.getElementById('edit-question-id').value = questionParts[0];
                    document.getElementById('oldquestion').value = questionParts[1];
                    //document.getElementById('edit-page-input').value = questionParts[2];
                });
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            const editButtons = document.querySelectorAll('.delete-question');
            editButtons.forEach(function(button) {
                button.addEventListener('click', function(event) {
                    const question_id = event.currentTarget.dataset.question;
                    document.getElementById('delete-question-id').value = question_id;
                });
            });
        });

        function addInputField() {
            // Create a new div element for the input field
            const newDiv = document.createElement('div');
            newDiv.classList.add('mb-3');

            // Create a new input element
            const newInput = document.createElement('input');
            newInput.type = 'text';
            newInput.className = 'form-control';
            newInput.name = 'question';
            newInput.placeholder = 'Enter your question here..'

            // Append the new input element to the new div
            newDiv.appendChild(newInput);

            // Append the new div to the form
            document.getElementById('addQuestionForm').appendChild(newDiv);
        }

        function submitQuestionAddForm() {
            const form = document.getElementById('addQuestionForm');
            var successToast = document.getElementById('borderedToast2');
            var errorContainer = document.getElementById('errorContainer');
            const formData = new FormData(form);

            // Add additional key-value pairs to the FormData object
            formData.append('document_id', '{{ file.id }}');

            var question = formData.getAll('question');
            const hasEmptyValue = question.some(value => value === "");
            if (hasEmptyValue) {
                errorContainer.innerText = 'Question input is required!';
                return;
            }

            // Make the API call
            fetch("{% url 'flforms_questions' %}", { 
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    var toastDiv = document.getElementById('toast-type');
                    toastDiv.classList.add('bg-danger');
                    document.querySelector('.toast-body').innerText="Something went wrong"; 
                }
                return response.json();
            })
            .then(data => {
                if (data.success){
                    var toastDiv = document.getElementById('toast-type');
                    toastDiv.classList.add('bg-success');
                    document.querySelector('.toast-body').innerText="Question added successfully!";
                }else{
                    var toastDiv = document.getElementById('toast-type');
                    toastDiv.classList.add('bg-danger');
                    document.querySelector('.toast-body').innerText=data.error;  
                }
                $('#QuestionModal').modal('hide');
                var toast = new bootstrap.Toast(successToast);
                toast.show();
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });
        }

        function submitQuestionEditForm() {
            const form = document.getElementById('editQuestionForm');
            var successToast = document.getElementById('borderedToast2');
            var errorContainer = document.getElementById('editErrorContainer');

            const formData = new FormData(form);

            // Add additional key-value pairs to the FormData object
            formData.append('document_id', '{{ file.id }}');

            var question = formData.get('editquestion');
            if (question === "") {
                errorContainer.innerText = 'Question input is required!';
                return;
            }
        
            // Make the API call
            fetch("{% url 'flforms_questions_edit' %}", { 
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success){
                    var toastDiv = document.getElementById('toast-type');
                    toastDiv.classList.add('bg-success');
                    document.querySelector('.toast-body').innerText="Question updated successfully!";
                }else{
                    var toastDiv = document.getElementById('toast-type');
                    toastDiv.classList.add('bg-danger');
                    document.querySelector('.toast-body').innerText=data.error;  
                }
                $('#editQuestionModal').modal('hide');
                var toast = new bootstrap.Toast(successToast);
                toast.show();
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });
        }


        function submitQuestionDeleteForm() {
            const form = document.getElementById('deleteQuestionForm');
            var successToast = document.getElementById('borderedToast2');
            const formData = new FormData(form);

            // Add additional key-value pairs to the FormData object
            formData.append('document_id', '{{ file.id }}');
        
            // Make the API call
            fetch("{% url 'flforms_questions_delete' %}", { 
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success){
                    var toastDiv = document.getElementById('toast-type');
                    toastDiv.classList.add('bg-success');
                    document.querySelector('.toast-body').innerText="Question deleted successfully!";
                }else{
                    var toastDiv = document.getElementById('toast-type');
                    toastDiv.classList.add('bg-danger');
                    document.querySelector('.toast-body').innerText=data.error;  
                }
                $('#deleteQuestionModal').modal('hide');
                var toast = new bootstrap.Toast(successToast);
                toast.show();
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });
        }

    </script>
{% endblock %}
