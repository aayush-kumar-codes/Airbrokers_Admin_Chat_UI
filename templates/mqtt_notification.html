<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
    
    <script>
        const mqttWebsocketUrl = '{{ MQTT_WEBSOCKET_URL }}';
        var brokerUrl = mqttWebsocketUrl;
        var clientId = "test-client_" + Math.random().toString(16).substr(2, 8);

        // const options = {
        //     userName: '{{ MQTT_USERNAME }}',
        //     password: '{{ MQTT_PASSWD }}',
        //     onSuccess: onConnect,
        //     onFailure: onFailure,
        // };

        // Create a client instance
        var client = new Paho.MQTT.Client(brokerUrl, clientId);

        // Set callback handlers
        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;

        // Connect the client
        client.connect({
            userName: '{{ MQTT_USERNAME }}',
            password: '{{ MQTT_PASSWD }}',
            onSuccess: onConnect,
            onFailure: onFailure,
        });

        // Called when the client connects
        function onConnect() {
            console.log("Connected to MQTT broker");

            var users = [
                {% for user in users %}
                    "{{ user.email }}",
                {% endfor %}
            ];

            var properties = [
                {% for property in properties %}
                    "{{ property.property_id }}",
                {% endfor %}
            ];
            

            // Subscribe to topics for each user
            users.forEach(function (email) {
                client.subscribe("user_chat/" + email);
                properties.forEach(function (property_id) {
                    client.subscribe(`user_customer_service_property_chat/${email}/${property_id}`);
                });
            });
        }

        function onFailure(error) {
            console.error('Failed to connect to MQTT broker:', error.errorMessage);
        }

        // Called when the client loses its connection
        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                alert("Connection lost: " + responseObject.errorMessage);
            }
        }

        // Called when a message arrives
        function onMessageArrived(message) {
            
            var payload = JSON.parse(message.payloadString);
            console.log("Message received: ", payload.message_content[0]);
            
            if (!payload.message_content[0].is_response) {
                
                if (payload.hasOwnProperty('key') && payload.key === 'user-customer_service-property-chat') {
                    showChat(temp_user)
                }   
                else{

                    var user_data = payload.message_content[0];
                    var listContainer = document.getElementById(`chat-ul-${payload.user_id}`);
                    var firstLetter = document.getElementById(`firstletter-${payload.user_id}`);
                    var userEmail = document.getElementById(`user_email-${payload.user_id}`);
                    const currentDate = new Date();
                    const formattedDate = currentDate.toGMTString();
                    var listItem = document.createElement('li');
                    var innerHTML = `
                        <div class="conversation-list">
                            <div class="d-flex">
                                <div class="avatar-sm align-self-center">
                                    <span class="avatar-title rounded-circle bg-primary-subtle text-primary">
                                        ${firstLetter.textContent}
                                    </span>
                                </div>
                                <div class="flex-1">
                                    <div class="ctext-wrap">
                                        <div class="ctext-wrap-content">
                                            <h5 class="conversation-name">
                                                <span class="time">${formattedDate}</span>
                                            </h5>
                    `;
                    
                    if (user_data.message) {
                        innerHTML += `<p class="mb-0">${user_data.message}</p>`;
                    }
                    if (user_data.media) {
                        var parts = user_data.media.split("/");
                        var filename = parts[parts.length - 1];
                       
                        if (user_data.media.endsWith('.jpg') || user_data.media.endsWith('.jpeg') || user_data.media.endsWith('.png')) {
                            innerHTML += `<a class="text-white" href="{{ API_URL }}${user_data.media}" target="_blank" download><i class="fa-regular fa-image fa-lg"></i> ${filename}</a>`;
                        } else {
                            innerHTML += `<a class="text-white" href="{{ API_URL }}${user_data.media}" target="_blank" download><i class="fa-solid fa-file-lines fa-lg"></i> ${filename}</a>`;
                        }
                        
                    }

                    innerHTML += `
                                        </div>
                                    </div>
                                </div>
                            </div>    
                        </div>    
                    `;
                    
                    listItem.innerHTML = innerHTML;
                    listContainer.appendChild(listItem);
                    scrollToLastMessage(userEmail.textContent);
                    
                } 

                showNotification("New message received from the User!", {
                    body: "Click to view the message."
                });
                 
                //window.location.reload(true);
            }
            
        }

        function showNotification(title, options) {
            if ("Notification" in window) {
                Notification.requestPermission().then(function (permission) {
                    if (permission === "granted") {
                        new Notification(title, options);
                    }
                });
            } else {
                alert(title);
            }
        }
    
    </script>